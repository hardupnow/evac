<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>evac.derived.derived &#8212; evac 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for evac.derived.derived</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; For computing derived variables from existing fields.</span>

<span class="sd">TODO: steal a lot of these from WRFOut.</span>
<span class="sd">TODO: there might be some overlap from stats.</span>

<span class="sd">For every class, parent is the class from which to &quot;inherit&quot; from.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">N</span>

<div class="viewcode-block" id="cold_pool_strength"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.cold_pool_strength">[docs]</a><span class="k">def</span> <span class="nf">cold_pool_strength</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">swath_width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dz</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns array the same shape as WRF domain.</span>

<span class="sd">    Args:</span>
<span class="sd">        X   :   cross-section object with given path</span>
<span class="sd">                    This path goes front-to-back through a bow</span>
<span class="sd">        km  :   width in the line-normal direction</span>
<span class="sd">        env :   (x,y) for location to sample environmental dpt</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set up slices</span>
    <span class="n">tidx</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_time_idx</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">lvidx</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">lonidx</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">latidx</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Get wind data</span>
    <span class="n">wind10</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wind10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>

    <span class="c1"># This is the 2D plane for calculation data</span>
    <span class="n">coldpooldata</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wind10</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Compute required C2 fields to save time</span>
    <span class="n">dpt</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpt&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:,:,:]</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:,:,:]</span>
    <span class="n">HGT</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HGT&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">Z</span><span class="o">-</span><span class="n">HGT</span>
    <span class="c1"># pdb.set_trace()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
        <span class="n">xx_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">yy_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">dpt_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">yy_env</span><span class="p">,</span><span class="n">xx_env</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># All cross-sections (parallel)</span>

    <span class="c1"># xxx = [X.xx,]</span>
    <span class="c1"># yyy = [X.yy,]</span>
    <span class="n">X</span><span class="o">.</span><span class="n">translate_xs</span><span class="p">(</span><span class="o">-</span><span class="n">swath_width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">swath_width</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Cross section #</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="c1"># for xx, yy in zip(xxx, yyy):</span>
        <span class="n">X</span><span class="o">.</span><span class="n">translate_xs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">xx</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">yy</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">wind_slice</span> <span class="o">=</span> <span class="n">wind10</span><span class="p">[</span><span class="n">yy</span><span class="p">,</span><span class="n">xx</span><span class="p">]</span>
        <span class="n">T2_slice</span> <span class="o">=</span> <span class="n">T2</span><span class="p">[</span><span class="n">yy</span><span class="p">,</span><span class="n">xx</span><span class="p">]</span>
        <span class="n">slice_loc</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">find_gust_front</span><span class="p">(</span><span class="n">wind_slice</span><span class="p">,</span><span class="n">T2_slice</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>

        <span class="n">gfx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">slice_loc</span><span class="p">]</span>
        <span class="n">gfy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">slice_loc</span><span class="p">]</span>
        <span class="n">gf_pts</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xx</span><span class="o">==</span><span class="n">gfx</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yy</span><span class="o">==</span><span class="n">gfy</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">gf_pt</span> <span class="o">=</span> <span class="n">gf_pts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gf_pts</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)]</span>
        <span class="n">xx_cp</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[:</span><span class="n">gf_pt</span><span class="p">]</span>
        <span class="n">yy_cp</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[:</span><span class="n">gf_pt</span><span class="p">]</span>
        <span class="c1"># pdb.set_trace()</span>

        <span class="c1"># Compute enviromental dpt at each height</span>
        <span class="c1"># Average all levels from the location of gust front</span>
        <span class="c1"># forwards to the end of the cross-section.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">xx_env</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">gf_pt</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">yy_env</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">gf_pt</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">dpt_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">yy_env</span><span class="p">,</span><span class="n">xx_env</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># pdb.set_trace()</span>

        <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xx_cp</span><span class="p">,</span><span class="n">yy_cp</span><span class="p">):</span>
        <span class="c1">#for x,y in zip(xx,yy):</span>
            <span class="k">if</span> <span class="n">dz</span><span class="p">:</span>
                <span class="n">coldpooldata</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_cpdz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">heights</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">dpt_env</span><span class="p">)</span>
                <span class="c1"># pdb.set_trace()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coldpooldata</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">compute_C2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">heights</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">dpt_env</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">coldpooldata</span></div>

<div class="viewcode-block" id="compute_cpdz"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_cpdz">[docs]</a><span class="k">def</span> <span class="nf">compute_cpdz</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cold pool depth</span>

<span class="sd">    Args:</span>
<span class="sd">        x       :   x location in domain</span>
<span class="sd">        y       :   y location in domain</span>
<span class="sd">        dpt     :   density potential temperature slice</span>
<span class="sd">        heights :   height AGL slice</span>
<span class="sd">        dpt_env :   environmental dpt, column</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dz</span><span class="p">,</span> <span class="n">zidx</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">cold_pool_depth</span><span class="p">(</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">)</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">dz</span></div>

<div class="viewcode-block" id="compute_C2"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_C2">[docs]</a><span class="k">def</span> <span class="nf">compute_C2</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    C^2 as found in James et al. 2006 MWR</span>

<span class="sd">    Args:</span>
<span class="sd">        x       :   x location in domain</span>
<span class="sd">        y       :   y location in domain</span>
<span class="sd">        dpt     :   density potential temperature slice</span>
<span class="sd">        heights :   height AGL slice</span>
<span class="sd">        dpt_env :   environmental dpt, column</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dz</span><span class="p">,</span> <span class="n">zidx</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">cold_pool_depth</span><span class="p">(</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">)</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">mc</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="p">((</span><span class="n">dpt</span><span class="p">[</span><span class="n">zidx</span><span class="p">]</span><span class="o">-</span><span class="n">dpt_env</span><span class="p">[</span><span class="n">zidx</span><span class="p">])</span><span class="o">/</span><span class="n">dpt_env</span><span class="p">[</span><span class="n">zidx</span><span class="p">])</span><span class="o">*</span><span class="n">dz</span>
    <span class="c1"># print(&quot;dpt = {0} ... dpt_env = {1} ... C2 = {2}&quot;.format(dpt[0],dpt_env[0],C2))</span>
    <span class="k">return</span> <span class="n">C2</span></div>

<div class="viewcode-block" id="cold_pool_depth"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.cold_pool_depth">[docs]</a><span class="k">def</span> <span class="nf">cold_pool_depth</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">):</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># thresh = -2.0</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">z</span><span class="p">,</span> <span class="n">de</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dpt</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">heights</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">dpt_env</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">dptp</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">de</span>
        <span class="k">if</span> <span class="n">dptp</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">z</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dz</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">zidx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">heights</span><span class="o">==</span><span class="n">dz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zidx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">dz</span><span class="p">,</span> <span class="n">zidx</span></div>

<div class="viewcode-block" id="find_gust_front"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.find_gust_front">[docs]</a><span class="k">def</span> <span class="nf">find_gust_front</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">wind_slice</span><span class="p">,</span><span class="n">T2_slice</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find location of maximum shear in the horizontal wind along a</span>
<span class="sd">    1D slice.</span>

<span class="sd">    Args:</span>
<span class="sd">        wind_slice      :   1D numpy array</span>
<span class="sd">        T2_slice        :   temp 2m slice</span>
<span class="sd">        angle           :   angle of slice cross-section</span>
<span class="sd">        method          :   way to locate gust front</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shp</span> <span class="o">=</span> <span class="n">wind_slice</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Compute gradient quantities</span>
    <span class="n">shear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
    <span class="n">T2grad</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">shear</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">len1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
            <span class="n">len2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
            <span class="n">hyp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">len1</span><span class="p">,</span><span class="n">len2</span><span class="p">))</span>
            <span class="c1"># In kilometres:</span>
            <span class="n">shear</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">wind_slice</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">wind_slice</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">hyp</span><span class="p">))</span><span class="o">*</span><span class="mf">1000.0</span>
            <span class="n">T2grad</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">T2_slice</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">T2_slice</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">hyp</span><span class="p">))</span><span class="o">*</span><span class="mf">1000.0</span>
            <span class="c1"># N.W.DX</span>

    <span class="c1"># pdb.set_trace()</span>

    <span class="c1"># Go from B to A</span>
    <span class="c1"># Find first location where T2 drops and shear is ?</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1">### METHOD 1: USING THRESHOLDS</span>
        <span class="c1"># By default</span>
        <span class="n">gfidx</span> <span class="o">=</span> <span class="n">shp</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">shp</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">shear</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">T2grad</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="mf">2.0</span><span class="p">):</span>
                <span class="n">gfidx</span> <span class="o">=</span> <span class="n">n</span>
                <span class="k">break</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>

        <span class="c1">### METHOD 2: FINDING MAX GRADIENTS AND AVERAGING</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">shear</span><span class="p">)</span>
        <span class="n">T2grad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">T2grad</span><span class="p">)</span>

        <span class="n">xsh_idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">shear</span> <span class="o">==</span> <span class="n">shear</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xtg_idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">T2grad</span> <span class="o">==</span> <span class="n">T2grad</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Max shear loc: </span><span class="si">{0}</span><span class="s2"> ... max tempgrad loc: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xsh_idx</span><span class="p">,</span><span class="n">xtg_idx</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">gfidx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">xsh_idx</span> <span class="o">+</span> <span class="n">xtg_idx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gfidx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">xsh_idx</span><span class="p">,</span><span class="n">xtg_idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">gfidx</span></div>
    <span class="c1"># maxshearloc[0][0] returns the integer</span>

<div class="viewcode-block" id="compute_frontogenesis"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_frontogenesis">[docs]</a><span class="k">def</span> <span class="nf">compute_frontogenesis</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Note that all variables fetched with parent.get have been</span>
<span class="sd">    destaggered and are at the same location.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Front       :   Frontgenesis in Kelvin per second.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="c1">#ds = 1 # Number of grid point to compute horizontal gradient over</span>
    <span class="c1">#dx = ds</span>
    <span class="c1">#dy = ds</span>
    <span class="c1">#dz = 1 # Normal for vertical</span>
    <span class="n">tidx</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_time_idx</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">tidxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">tidx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">tidx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tidx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tidx</span> <span class="o">==</span> <span class="n">parent</span><span class="o">.</span><span class="n">wrf_times</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">Front</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nt</span><span class="p">,</span><span class="n">nl</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">])</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="c1"># Use the bottom three model levels</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tidxs</span><span class="p">):</span>
                <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">W</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">P</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="c1"># Average different in pressure between model levels</span>
                <span class="c1"># This field is passed into the gradient</span>
                <span class="c1"># THIS IS NOT USED RIGHT NOW</span>
                <span class="n">dp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:])</span> <span class="o">+</span>
                            <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]))))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1"># hPa to compute vertical gradients</span>

            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tidxs</span><span class="p">):</span>
                <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>
                <span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>
                <span class="n">W</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>

                <span class="c1"># 3D array has dimensions (vertical, horz, horz)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,(</span><span class="n">level</span><span class="o">-</span><span class="n">dp</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">level</span><span class="o">+</span><span class="n">dp</span><span class="p">))</span>

                <span class="c1"># Compute omega</span>
                <span class="c1"># P = rho* R* drybulb</span>
                <span class="c1"># drybulb = T/((P0/P)^(R/cp)</span>

        <span class="n">drybulb</span> <span class="o">=</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="p">((</span><span class="mf">100000.0</span><span class="o">/</span><span class="p">(</span><span class="n">level</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">R</span><span class="o">/</span><span class="n">mc</span><span class="o">.</span><span class="n">cp</span><span class="p">)))</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">drybulb</span><span class="p">)</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="o">-</span><span class="n">rho</span> <span class="o">*</span> <span class="n">mc</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">W</span>

        <span class="c1"># Time difference in sec</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">utc</span><span class="p">[</span><span class="n">tidx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
        <span class="n">dTdt</span><span class="p">,</span> <span class="n">dTdz</span><span class="p">,</span> <span class="n">dTdy</span><span class="p">,</span> <span class="n">dTdx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">dp</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="c1"># Gradient part</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">dTdx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dTdy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1"># Full derivative - value wrong for dgraddz here</span>
        <span class="n">dgraddt</span><span class="p">,</span> <span class="n">dgraddz</span><span class="p">,</span> <span class="n">dgraddy</span><span class="p">,</span> <span class="n">dgraddx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">dp</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="c1"># Full equation</span>
        <span class="n">Front</span> <span class="o">=</span> <span class="n">dgraddt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">*</span><span class="n">dgraddx</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">*</span><span class="n">dgraddy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="c1"># + omega[1,1,:,:]*dgraddz[1,1,:,:]</span>
    <span class="k">return</span> <span class="n">Front</span></div>

<div class="viewcode-block" id="compute_accum_rain"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_accum_rain">[docs]</a><span class="k">def</span> <span class="nf">compute_accum_rain</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">utc</span><span class="p">,</span><span class="n">accum_hr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Needs to be expanded to include other precip</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_datenum</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">idx0</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_time_idx</span><span class="p">(</span><span class="n">dn</span><span class="o">-</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="n">accum_hr</span><span class="p">))</span>
    <span class="n">idx1</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_time_idx</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
    <span class="c1"># range_idx = range(start_idx,end_idx+1)</span>
    <span class="n">total0</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RAINNC&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">idx0</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RAINC&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">idx0</span><span class="p">))</span>
    <span class="n">total1</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RAINNC&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">idx1</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RAINC&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">idx1</span><span class="p">))</span>
    <span class="n">accum</span> <span class="o">=</span> <span class="n">total1</span> <span class="o">-</span> <span class="n">total0</span>
    <span class="k">return</span> <span class="n">accum</span></div>

<div class="viewcode-block" id="compute_satvappres"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_satvappres">[docs]</a><span class="k">def</span> <span class="nf">compute_satvappres</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drybulb&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">es</span> <span class="o">=</span> <span class="mf">6.1</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.073</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">es</span></div>

<div class="viewcode-block" id="compute_vappres"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_vappres">[docs]</a><span class="k">def</span> <span class="nf">compute_vappres</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">RH</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RH&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;es&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">RH</span><span class="o">*</span><span class="n">es</span>
    <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="compute_spechum"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_spechum">[docs]</a><span class="k">def</span> <span class="nf">compute_spechum</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;es&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mf">0.622</span><span class="o">*</span><span class="p">(</span><span class="n">es</span><span class="o">/</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="compute_Td_2"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_Td_2">[docs]</a><span class="k">def</span> <span class="nf">compute_Td_2</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Another version of Td</span>
<span class="sd">    From p70 Djuric Weather Analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="mi">273</span><span class="o">*</span><span class="p">((</span><span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">6.1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">19.8</span> <span class="o">-</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">6.1</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>
        <span class="n">Td</span> <span class="o">=+</span> <span class="mf">273.15</span>
    <span class="k">return</span> <span class="n">Td</span></div>

<div class="viewcode-block" id="compute_derivatives"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_derivatives">[docs]</a><span class="k">def</span> <span class="nf">compute_derivatives</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">dargs</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">dkwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dudx</span><span class="p">,</span> <span class="n">dudy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">dvdx</span><span class="p">,</span> <span class="n">dvdy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dudx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">dvdx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">dudy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">dvdy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">dudx</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">dudy</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
            <span class="n">dvdx</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">dvdy</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dudx</span><span class="p">,</span> <span class="n">dudy</span><span class="p">,</span> <span class="n">dvdx</span><span class="p">,</span> <span class="n">dvdy</span></div>

<div class="viewcode-block" id="compute_stretch_deformation"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_stretch_deformation">[docs]</a><span class="k">def</span> <span class="nf">compute_stretch_deformation</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">):</span>
    <span class="n">dudx</span><span class="p">,</span> <span class="n">dudy</span><span class="p">,</span> <span class="n">dvdx</span><span class="p">,</span> <span class="n">dvdy</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_derivatives</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Est</span> <span class="o">=</span> <span class="n">dudx</span> <span class="o">-</span> <span class="n">dvdy</span>
    <span class="k">return</span> <span class="n">Est</span></div>

<div class="viewcode-block" id="compute_shear_deformation"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_shear_deformation">[docs]</a><span class="k">def</span> <span class="nf">compute_shear_deformation</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">):</span>
    <span class="n">dudx</span><span class="p">,</span> <span class="n">dudy</span><span class="p">,</span> <span class="n">dvdx</span><span class="p">,</span> <span class="n">dvdy</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_derivatives</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Esh</span> <span class="o">=</span> <span class="n">dudy</span> <span class="o">+</span> <span class="n">dvdx</span>
    <span class="k">return</span> <span class="n">Esh</span></div>

<div class="viewcode-block" id="compute_total_deformation"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_total_deformation">[docs]</a><span class="k">def</span> <span class="nf">compute_total_deformation</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">):</span>
    <span class="n">Esh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_shear_deformation</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Est</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_stretch_deformation</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="n">Est</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Esh</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">E</span></div>

<div class="viewcode-block" id="compute_vorticity"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_vorticity">[docs]</a><span class="k">def</span> <span class="nf">compute_vorticity</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns vertical vorticity. In future, change to allow all thre</span>
<span class="sd">    components to be be returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dudx</span><span class="p">,</span> <span class="n">dudy</span><span class="p">,</span> <span class="n">dvdx</span><span class="p">,</span> <span class="n">dvdy</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_derivatives</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">,)</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">dvdx</span> <span class="o">-</span> <span class="n">dudy</span>
    <span class="k">return</span> <span class="n">zeta</span></div>

<div class="viewcode-block" id="return_vorticity"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.return_vorticity">[docs]</a><span class="k">def</span> <span class="nf">return_vorticity</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_vorticity</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">zeta</span></div>

<div class="viewcode-block" id="compute_fluid_trapping_diagnostic"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_fluid_trapping_diagnostic">[docs]</a><span class="k">def</span> <span class="nf">compute_fluid_trapping_diagnostic</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_total_deformation</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_vorticity</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">omega2</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">zeta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">omega2</span></div>

<div class="viewcode-block" id="compute_divergence"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_divergence">[docs]</a><span class="k">def</span> <span class="nf">compute_divergence</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">):</span>
    <span class="n">dudx</span><span class="p">,</span> <span class="n">dudy</span><span class="p">,</span> <span class="n">dvdx</span><span class="p">,</span> <span class="n">dvdy</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_derivatives</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">div</span> <span class="o">=</span> <span class="n">dudx</span> <span class="o">+</span> <span class="n">dvdy</span>
    <span class="k">return</span> <span class="n">div</span></div>

<div class="viewcode-block" id="compute_instantaneous_local_Lyapunov"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_instantaneous_local_Lyapunov">[docs]</a><span class="k">def</span> <span class="nf">compute_instantaneous_local_Lyapunov</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_total_deformation</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_vorticity</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">div</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_divergence</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">EzArr</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="o">**</span><span class="mi">2</span>  <span class="o">-</span> <span class="n">zeta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Ez_nonan</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">EzArr</span><span class="p">)</span>
    <span class="c1"># D =  0.5*(div + (E**2  - zeta**2)**0.5)</span>
    <span class="n">D</span> <span class="o">=</span>  <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="n">Ez_nonan</span><span class="p">)</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">D</span></div>

<div class="viewcode-block" id="return_axis_of_dilatation_components"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.return_axis_of_dilatation_components">[docs]</a><span class="k">def</span> <span class="nf">return_axis_of_dilatation_components</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lonidx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">latidx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">Esh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_shear_deformation</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">Est</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_stretch_deformation</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_total_deformation</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_vorticity</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>

    <span class="n">psi1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Esh</span><span class="p">,</span><span class="n">Est</span><span class="p">)</span>
    <span class="c1"># chi1 = psi1 + 0.5*N.nan_to_num(N.arcsin(zeta/E))</span>
    <span class="n">chi1</span> <span class="o">=</span> <span class="n">psi1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">zeta</span><span class="o">/</span><span class="n">E</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">chi1</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">chi1</span><span class="p">)</span></div>

<div class="viewcode-block" id="compute_omega"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_omega">[docs]</a><span class="k">def</span> <span class="nf">compute_omega</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="c1"># Rising motion in Pa/s</span>
    <span class="c1"># dp/dt of air parcel</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:,:,:]</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:,:,:]</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="o">-</span><span class="n">rho</span> <span class="o">*</span> <span class="o">-</span><span class="n">mc</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">W</span> <span class="c1"># I think it&#39;s meant to be minus g?</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">omega</span></div>

<div class="viewcode-block" id="compute_density"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_density">[docs]</a><span class="k">def</span> <span class="nf">compute_density</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">drybulb</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drybulb&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">P</span><span class="o">/</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">drybulb</span><span class="p">)</span>
    <span class="c1"># drybulb = 273.15 + (T/((100000.0/(level*100.0))**(mc.R/mc.cp)))</span>
    <span class="k">return</span> <span class="n">rho</span></div>

<div class="viewcode-block" id="compute_CAPE"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_CAPE">[docs]</a><span class="k">def</span> <span class="nf">compute_CAPE</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    INCOMPLETE!</span>

<span class="sd">    CAPE method based on GEMPAK&#39;s pdsuml.f function</span>

<span class="sd">    Inputs:</span>

<span class="sd">    tidx,lvidx,lonidx,latidx  :   dictionary of level/time/lat/lon</span>



<span class="sd">    Outputs:</span>
<span class="sd">    CAPE    :   convective available potential energy</span>
<span class="sd">    CIN     :   convective inhibition</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure all levels are obtained</span>
    <span class="c1">#tidx,lvidx,lonidx,latidx[&#39;lv&#39;] = slice(None,None)</span>

    <span class="n">totalCAPE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">totalCIN</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lvidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lvidx</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># This should loop over the levels?</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        z1      :   bottom of layer (index)</span>
<span class="sd">        z2      :   top of layer (index)</span>
<span class="sd">        th1     :   theta (environ) at z1</span>
<span class="sd">        th2     :   theta (environ) at z2</span>
<span class="sd">        thp1    :   theta (parcel) at z1</span>
<span class="sd">        thp2    :   theta (parcel) at z2</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">z1</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="n">th1</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">th2</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="n">thp1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">thp2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">capeT</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">cinT</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">dt2</span> <span class="o">=</span> <span class="n">thp2</span> <span class="o">-</span> <span class="n">th2</span>
        <span class="n">dt1</span> <span class="o">=</span> <span class="n">thp1</span> <span class="o">-</span> <span class="n">th1</span>

        <span class="n">dz</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">z1</span>

        <span class="n">dt1_pos_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dt1_neg_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">dt2_pos_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dt2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dt2_neg_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">dt2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">dt1_pos</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>
        <span class="n">dt1_neg</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>
        <span class="n">dt2_pos</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>
        <span class="n">dt2_neg</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt2</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>

        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dt1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dt2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">capeT</span> <span class="o">=</span> <span class="p">((</span><span class="n">dt2</span> <span class="o">+</span> <span class="n">dt1</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">th2</span><span class="o">+</span><span class="n">th1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dt1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">dt1</span><span class="o">/</span><span class="p">(</span><span class="n">dt1</span><span class="o">-</span><span class="n">dt2</span><span class="p">)</span>
            <span class="n">zeq</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="p">(</span><span class="n">dz</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
            <span class="n">teq</span> <span class="o">=</span> <span class="n">th1</span> <span class="o">+</span> <span class="p">((</span><span class="n">th2</span><span class="o">-</span><span class="n">th1</span><span class="p">)</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
            <span class="n">capeT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt1</span><span class="o">*</span><span class="p">(</span><span class="n">zeq</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">th1</span><span class="o">+</span><span class="n">teq</span><span class="p">)</span>
            <span class="n">cinT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt2</span><span class="o">*</span><span class="p">(</span><span class="n">z2</span><span class="o">-</span><span class="n">zeq</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">th2</span><span class="o">+</span><span class="n">teq</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dt2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">/</span><span class="p">(</span><span class="n">dt2</span><span class="o">-</span><span class="n">dt1</span><span class="p">)</span>
            <span class="n">zfc</span> <span class="o">=</span> <span class="n">z2</span><span class="o">-</span><span class="p">(</span><span class="n">dz</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
            <span class="n">tfc</span> <span class="o">=</span> <span class="n">th2</span><span class="o">-</span><span class="p">((</span><span class="n">th2</span><span class="o">-</span><span class="n">th1</span><span class="p">)</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
            <span class="n">capeT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt2</span><span class="o">*</span><span class="p">(</span><span class="n">z2</span><span class="o">-</span><span class="n">zfc</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tfc</span><span class="o">+</span><span class="n">th2</span><span class="p">))</span>
            <span class="n">cinT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt1</span><span class="o">*</span><span class="p">(</span><span class="n">zfc</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tfc</span><span class="o">+</span><span class="n">th1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cinT</span> <span class="o">=</span> <span class="p">((</span><span class="n">dt2</span><span class="o">+</span><span class="n">dt1</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">th2</span><span class="o">+</span><span class="n">th1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">capeT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">CAPE</span> <span class="o">=</span> <span class="n">capeT</span> <span class="o">*</span> <span class="n">cc</span><span class="o">.</span><span class="n">g</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CAPE</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">cinT</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">CIN</span> <span class="o">=</span> <span class="n">cinT</span> <span class="o">*</span> <span class="n">cc</span><span class="o">.</span><span class="n">g</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CIN</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">totalCAPE</span> <span class="o">+=</span> <span class="n">CAPE</span>
            <span class="n">totalCIN</span> <span class="o">+=</span> <span class="n">CIN</span>

    <span class="k">return</span> <span class="n">totalCAPE</span><span class="p">,</span><span class="n">totalCIN</span></div>

<div class="viewcode-block" id="compute_RH"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_RH">[docs]</a><span class="k">def</span> <span class="nf">compute_RH</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drybulb&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Td&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">RH</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.073</span><span class="o">*</span><span class="p">(</span><span class="n">Td</span><span class="o">-</span><span class="n">T</span><span class="p">))</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">RH</span><span class="o">*</span><span class="mf">100.0</span></div>

<div class="viewcode-block" id="compute_temp_advection"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_temp_advection">[docs]</a><span class="k">def</span> <span class="nf">compute_temp_advection</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drybulb&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">dTdx</span><span class="p">,</span> <span class="n">dTdy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">DX</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">DY</span><span class="p">)</span>
    <span class="n">field</span> <span class="o">=</span> <span class="o">-</span><span class="n">U</span><span class="o">*</span><span class="n">dTdx</span> <span class="o">-</span> <span class="n">V</span><span class="o">*</span><span class="n">dTdy</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">field</span></div>

<div class="viewcode-block" id="compute_PMSL_gradient"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_PMSL_gradient">[docs]</a><span class="k">def</span> <span class="nf">compute_PMSL_gradient</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PMSL&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">dPdx</span><span class="p">,</span> <span class="n">dPdy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dPdx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dPdy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">field</span></div>

<div class="viewcode-block" id="compute_T2_gradient"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_T2_gradient">[docs]</a><span class="k">def</span> <span class="nf">compute_T2_gradient</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
    <span class="n">dTdx</span><span class="p">,</span> <span class="n">dTdy</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dTdx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dTdy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># import pdb; pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">field</span></div>

<div class="viewcode-block" id="compute_dryairmass"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_dryairmass">[docs]</a><span class="k">def</span> <span class="nf">compute_dryairmass</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">MU</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MU&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">MUB</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MUB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">MU</span> <span class="o">+</span> <span class="n">MUB</span></div>

<div class="viewcode-block" id="compute_pmsl"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_pmsl">[docs]</a><span class="k">def</span> <span class="nf">compute_pmsl</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PSFC&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">HGT</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HGT&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">T2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">6.5</span><span class="o">*</span><span class="n">HGT</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.0</span>
    <span class="n">pmsl</span> <span class="o">=</span> <span class="n">P</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">9.81</span><span class="o">/</span><span class="p">(</span><span class="mf">287.0</span><span class="o">*</span><span class="n">temp</span><span class="p">)</span><span class="o">*</span><span class="n">HGT</span><span class="p">)</span>

    <span class="c1">#sm = kwargs.get(&#39;smooth&#39;,1)</span>
    <span class="c1">#data = pmsl[0,::sm,::sm]</span>
    <span class="c1">#return data</span>
    <span class="k">return</span> <span class="n">pmsl</span></div>

<div class="viewcode-block" id="compute_buoyancy"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_buoyancy">[docs]</a><span class="k">def</span> <span class="nf">compute_buoyancy</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method from Adams-Selin et al., 2013, WAF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">thetabar</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">qv</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QVAPOR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">qvbar</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">qv</span><span class="p">)</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="p">((</span><span class="n">theta</span><span class="o">-</span><span class="n">thetabar</span><span class="p">)</span><span class="o">/</span><span class="n">thetabar</span> <span class="o">+</span> <span class="mf">0.61</span><span class="o">*</span><span class="p">(</span><span class="n">qv</span> <span class="o">-</span> <span class="n">qvbar</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">B</span></div>

<div class="viewcode-block" id="compute_mixing_ratios"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_mixing_ratios">[docs]</a><span class="k">def</span> <span class="nf">compute_mixing_ratios</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">qv</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QVAPOR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">qc</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QCLOUD&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QRAIN&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">qi</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QICE&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MP scheme has no ice data.&quot;</span><span class="p">)</span>
        <span class="n">qi</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QSNOW&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MP scheme has no snow data.&quot;</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">qg</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QGRAUP&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MP scheme has no graupel data.&quot;</span><span class="p">)</span>
        <span class="n">qg</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">rh</span> <span class="o">=</span> <span class="n">qc</span> <span class="o">+</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qs</span> <span class="o">+</span> <span class="n">qg</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">qv</span>

    <span class="k">return</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rv</span></div>

<div class="viewcode-block" id="compute_qtotal"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_qtotal">[docs]</a><span class="k">def</span> <span class="nf">compute_qtotal</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">qtotal</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_mixing_ratios</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qtotal</span></div>

<div class="viewcode-block" id="compute_dptp"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_dptp">[docs]</a><span class="k">def</span> <span class="nf">compute_dptp</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">dpt</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpt&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">dpt_mean</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dpt</span><span class="p">)</span>
    <span class="n">dptp</span> <span class="o">=</span> <span class="n">dpt</span> <span class="o">-</span> <span class="n">dpt_mean</span>
    <span class="k">return</span> <span class="n">dptp</span></div>

<div class="viewcode-block" id="compute_T2_pertub"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_T2_pertub">[docs]</a><span class="k">def</span> <span class="nf">compute_T2_pertub</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">T2_mean</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span>
    <span class="n">T2p</span> <span class="o">=</span> <span class="n">T2</span><span class="o">-</span><span class="n">T2_mean</span>
    <span class="k">return</span> <span class="n">T2p</span></div>

<div class="viewcode-block" id="compute_Q_pert"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_Q_pert">[docs]</a><span class="k">def</span> <span class="nf">compute_Q_pert</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QVAPOR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">Q_mean</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">Qp</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-</span><span class="n">Q_mean</span>
    <span class="k">return</span> <span class="n">Qp</span></div>

<div class="viewcode-block" id="compute_dpt"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_dpt">[docs]</a><span class="k">def</span> <span class="nf">compute_dpt</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Potential: if surface level is requested, choose sigma level just</span>
<span class="sd">    about the surface. I don&#39;t think this affects any</span>
<span class="sd">    other dictionaries around...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if tidx,lvidx,lonidx,latidx[&#39;lv&#39;] == 0:</span>
        <span class="c1"># tidx,lvidx,lonidx,latidx[&#39;lv&#39;] = 0</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">rh</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">compute_mixing_ratios</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="n">dpt</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.61</span><span class="o">*</span><span class="n">rv</span> <span class="o">-</span> <span class="n">rh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dpt</span></div>

<div class="viewcode-block" id="compute_geopotential_height"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_geopotential_height">[docs]</a><span class="k">def</span> <span class="nf">compute_geopotential_height</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">geopotential</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PH&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">geopotential</span><span class="o">/</span><span class="mf">9.81</span>
    <span class="k">return</span> <span class="n">Z</span></div>

<div class="viewcode-block" id="compute_geopotential"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_geopotential">[docs]</a><span class="k">def</span> <span class="nf">compute_geopotential</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">geopotential</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PH&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">geopotential</span></div>

<div class="viewcode-block" id="compute_wind10"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_wind10">[docs]</a><span class="k">def</span> <span class="nf">compute_wind10</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="compute_pressure"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_pressure">[docs]</a><span class="k">def</span> <span class="nf">compute_pressure</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">PP</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">PB</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">pressure</span> <span class="o">=</span> <span class="n">PP</span> <span class="o">+</span> <span class="n">PB</span>
    <span class="k">return</span> <span class="n">pressure</span></div>

<div class="viewcode-block" id="compute_drybulb"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_drybulb">[docs]</a><span class="k">def</span> <span class="nf">compute_drybulb</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="c1"># Theta-e at level 2</span>
    <span class="n">drybulb</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="p">((</span><span class="n">P</span><span class="o">/</span><span class="mf">100000.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">287.04</span><span class="o">/</span><span class="mf">1004.0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">==</span><span class="s1">&#39;K&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">drybulb</span>
    <span class="k">elif</span> <span class="n">other</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">drybulb</span><span class="o">-</span><span class="mf">273.15</span></div>

<div class="viewcode-block" id="compute_theta"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_theta">[docs]</a><span class="k">def</span> <span class="nf">compute_theta</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">Tbase</span> <span class="o">=</span> <span class="mf">300.0</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">Tbase</span> <span class="o">+</span> <span class="n">theta</span>
    <span class="k">return</span> <span class="n">theta</span></div>

<div class="viewcode-block" id="compute_wind"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_wind">[docs]</a><span class="k">def</span> <span class="nf">compute_wind</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="compute_shear"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_shear">[docs]</a><span class="k">def</span> <span class="nf">compute_shear</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        other   :      dictionary of &#39;top&#39; and &#39;bottom&#39; levels, km</span>

<span class="sd">    Todos:</span>
<span class="sd">        * Could make this faster with numpy.digitize()?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No shear heights specified. Using 0-6 km by default.&quot;</span><span class="p">)</span>
        <span class="n">topm</span> <span class="o">=</span> <span class="mf">6000.0</span>
        <span class="n">botm</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># print(&quot;Choose top and bottom for shear calc.&quot;)</span>
        <span class="c1"># raise Exception</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">topm</span> <span class="o">=</span> <span class="n">other</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
        <span class="n">botm</span> <span class="o">=</span> <span class="n">other</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="n">topidx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parent</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">))</span>
    <span class="n">botidx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parent</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">))</span>
    <span class="n">ushear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parent</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">))</span>
    <span class="n">vshear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parent</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">x_dim</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">y_dim</span><span class="p">):</span>
            <span class="c1"># import pdb; pdb.set_trace()</span>
            <span class="n">topidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                            <span class="n">topm</span><span class="p">,</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">z_dim</span><span class="p">))))</span>
            <span class="n">botidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                            <span class="n">botm</span><span class="p">,</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">z_dim</span><span class="p">))))</span>
            <span class="n">ushear</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">topidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">botidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">vshear</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">topidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">botidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="c1"># Find indices of bottom and top levels</span>
    <span class="c1"># topidx = N.where(abs(Z-topm) == abs(Z-topm).min(axis=1))</span>
    <span class="c1"># botidx = N.where(abs(Z-botm) == abs(Z-botm).min(axis=1))</span>

    <span class="c1"># ushear = u[0,:,topidx] - u[0,:,botidx]</span>
    <span class="c1"># vshear = v[0,topidx,:,:] - v[0,botidx,:,:]</span>

    <span class="n">shear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ushear</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vshear</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">shear</span></div>

<span class="k">def</span> <span class="nf">compute_thetae</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="c1"># Computed</span>
    <span class="n">Drybulb</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="n">thetae</span> <span class="o">=</span> <span class="p">(</span><span class="n">Drybulb</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">cc</span><span class="o">.</span><span class="n">Lv</span><span class="o">/</span><span class="n">cc</span><span class="o">.</span><span class="n">cp</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">P0</span><span class="o">/</span><span class="n">P</span><span class="p">)</span> <span class="o">**</span> <span class="n">cc</span><span class="o">.</span><span class="n">kappa</span>
    <span class="k">return</span> <span class="n">thetae</span>

<div class="viewcode-block" id="compute_olr"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_olr">[docs]</a><span class="k">def</span> <span class="nf">compute_olr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">OLR</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OLR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">sbc</span> <span class="o">=</span> <span class="mf">0.000000056704</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="p">((</span><span class="n">OLR</span><span class="o">/</span><span class="n">sbc</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
    <span class="k">return</span> <span class="n">ir</span></div>

<div class="viewcode-block" id="compute_REFL_comp"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_REFL_comp">[docs]</a><span class="k">def</span> <span class="nf">compute_REFL_comp</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># lvidx = None</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="n">refl</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REFL_10CM&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:,:,:]</span>
    <span class="n">refl_comp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">refl_comp</span></div>

<div class="viewcode-block" id="compute_comp_ref"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_comp_ref">[docs]</a><span class="k">def</span> <span class="nf">compute_comp_ref</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Amend this so variables obtain at start fetch only correct date, lats, lons</span>
<span class="sd">    All levels need to be fetched as this is composite reflectivity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="c1"># QR = parent.nc.variables[&#39;QRAIN&#39;][PS[&#39;t&#39;],:,PS[&#39;la&#39;],PS[&#39;lo&#39;]]</span>
    <span class="n">QR</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QRAIN&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="c1"># This should get all levels</span>
    <span class="n">PSFC</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PSFC&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">QS</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QSNOW&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">QS</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">QR</span><span class="p">))</span>
    <span class="n">rhor</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="n">rhos</span> <span class="o">=</span> <span class="mf">100.0</span>
    <span class="n">rhog</span> <span class="o">=</span> <span class="mf">400.0</span>
    <span class="n">rhoi</span> <span class="o">=</span> <span class="mf">917.0</span>

    <span class="n">no_rain</span> <span class="o">=</span> <span class="mf">8.0E6</span>
    <span class="c1"># How do I access this time?</span>
    <span class="n">no_snow</span> <span class="o">=</span> <span class="mf">2.0E6</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="o">*</span><span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="mf">273.15</span><span class="p">))</span>
    <span class="n">no_grau</span> <span class="o">=</span> <span class="mf">4.0E6</span>

    <span class="n">density</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">PSFC</span><span class="p">,(</span><span class="mf">287.0</span> <span class="o">*</span> <span class="n">T2</span><span class="p">))</span>
    <span class="n">Qra_all</span> <span class="o">=</span> <span class="n">QR</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
    <span class="n">Qsn_all</span> <span class="o">=</span> <span class="n">QS</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Qra_all</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">curcol_r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curcol_s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Qra_all</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:])):</span>
                <span class="n">maxrval</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Qra_all</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">maxsval</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Qsn_all</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">curcol_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxrval</span><span class="p">)</span>
                <span class="n">curcol_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxsval</span><span class="p">)</span>
        <span class="n">N_curcol_r</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curcol_r</span><span class="p">)</span>
        <span class="n">N_curcol_s</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curcol_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Qra</span> <span class="o">=</span> <span class="n">N_curcol_r</span>
            <span class="n">Qsn</span> <span class="o">=</span> <span class="n">N_curcol_s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Qra</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">row_stack</span><span class="p">((</span><span class="n">Qra</span><span class="p">,</span> <span class="n">N_curcol_r</span><span class="p">))</span>
            <span class="n">Qsn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">row_stack</span><span class="p">((</span><span class="n">Qsn</span><span class="p">,</span> <span class="n">N_curcol_s</span><span class="p">))</span>

    <span class="c1"># Calculate slope factor lambda</span>
    <span class="n">lambr</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">3.14159</span> <span class="o">*</span> <span class="n">no_rain</span> <span class="o">*</span> <span class="n">rhor</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">density</span><span class="p">,</span> <span class="n">Qra</span><span class="p">)</span><span class="o">+</span><span class="n">N</span><span class="o">.</span><span class="n">nextafter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="o">**</span> <span class="mf">0.25</span>
    <span class="n">lambs</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0536</span> <span class="o">*</span> <span class="p">(</span><span class="n">T2</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">))</span>

    <span class="c1"># Calculate equivalent reflectivity factor</span>
    <span class="n">Zer</span> <span class="o">=</span> <span class="p">(</span><span class="mf">720.0</span> <span class="o">*</span> <span class="n">no_rain</span> <span class="o">*</span> <span class="p">(</span><span class="n">lambr</span> <span class="o">**</span> <span class="o">-</span><span class="mf">7.0</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">E18</span>
    <span class="n">Zes</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.224</span> <span class="o">*</span> <span class="mf">720.0</span> <span class="o">*</span> <span class="n">no_snow</span> <span class="o">*</span> <span class="p">(</span><span class="n">lambr</span> <span class="o">**</span> <span class="o">-</span><span class="mf">7.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhos</span><span class="o">/</span><span class="n">rhoi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">E18</span>
    <span class="n">Zes_int</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="n">lambs</span> <span class="o">*</span> <span class="n">Qsn</span> <span class="o">*</span> <span class="n">density</span><span class="p">),</span> <span class="n">no_snow</span><span class="p">)</span>
    <span class="n">Zes</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.224</span> <span class="o">*</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">1</span><span class="n">E18</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.14159</span> <span class="o">*</span> <span class="n">rhor</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Zes_int</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">Ze</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Zer</span><span class="p">,</span> <span class="n">Zes</span><span class="p">)</span>
    <span class="n">dBZ</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Ze</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dBZ</span></div>

<div class="viewcode-block" id="compute_simref_atlevel"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_simref_atlevel">[docs]</a><span class="k">def</span> <span class="nf">compute_simref_atlevel</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">pass</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="compute_DCP"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_DCP">[docs]</a><span class="k">def</span> <span class="nf">compute_DCP</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derecho Composite Parameter (Evans and Doswell, 2001, WAF)</span>
<span class="sd">    And info from SPC Mesoanalyses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DCAPE</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DCAPE&#39;</span><span class="p">)</span>
    <span class="n">MUCAPE</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MUCAPE&#39;</span><span class="p">)</span>
    <span class="n">shear_0_6</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shear&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">meanwind_0_6</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;meanwind&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">DCP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DCAPE</span><span class="o">/</span><span class="mf">980.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">MUCAPE</span><span class="o">/</span><span class="mf">2000.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">shear_0_6</span><span class="o">/</span><span class="mf">20.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">meanwind_0_6</span><span class="o">/</span><span class="mf">16.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DCP</span></div>

<div class="viewcode-block" id="compute_DCAPE"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_DCAPE">[docs]</a><span class="k">def</span> <span class="nf">compute_DCAPE</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>

    <span class="k">pass</span></div>

<div class="viewcode-block" id="compute_thetae"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_thetae">[docs]</a><span class="k">def</span> <span class="nf">compute_thetae</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drybulb&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Td&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">p2</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">drylift</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Td</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="mf">100.0</span><span class="p">)</span>
    <span class="n">thetae</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetae</span></div>


<div class="viewcode-block" id="compute_Td"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_Td">[docs]</a><span class="k">def</span> <span class="nf">compute_Td</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Using HootPy equation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QVAPOR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Q</span><span class="p">))</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">P</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.622</span><span class="p">,</span><span class="n">w</span><span class="p">))</span><span class="o">/</span><span class="mf">100.0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">243.5</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mf">6.112</span><span class="p">)))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mf">17.67</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mf">6.112</span><span class="p">)))</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="k">return</span> <span class="n">Td</span></div>



<div class="viewcode-block" id="compute_strongest_wind"><a class="viewcode-back" href="../../../evac.derived.derived.html#evac.derived.derived.compute_strongest_wind">[docs]</a><span class="k">def</span> <span class="nf">compute_strongest_wind</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pass the array of time indices and it will find the max</span>
<span class="sd">    along that axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;WSPD10MAX&#39;</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">ww</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WSPD10MAX&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ww</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using WSPD10MAX data&quot;</span><span class="p">)</span>
            <span class="n">wind</span> <span class="o">=</span> <span class="n">ww</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using wind10 data&quot;</span><span class="p">)</span>
            <span class="n">wind</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wind10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using wind10 data&quot;</span><span class="p">)</span>
        <span class="n">wind</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wind10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
    <span class="n">wind_max</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># wind_max_smooth = parent.test_smooth(wind_max)</span>
    <span class="c1"># return wind_max_smooth</span>

    <span class="k">return</span> <span class="n">wind_max</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, John Lawson.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>